<html>
  <head>
    <link rel="stylesheet" href="./src/index.css" />
  </head>
  <body>
    <canvas></canvas>
    <div>
      Select a pattern
      <select id="selectPattern" onchange="handleChange()">
      </select>
      <p id="description"></p>
      <button onclick="evolution()">Start</button>
    </div>
  </body>
  <script>
    const scale = 4;
    const worldWidth = 480;
    const worldHeight = 240;

    const canvas = document.querySelector("canvas");
    canvas.width = worldWidth * scale;
    canvas.height = worldHeight * scale;
    const ctx = canvas.getContext("2d");

    const render = (world) => {
      ctx.fillStyle = "#202020";
      ctx.fillRect(0, 0, worldWidth * scale, worldHeight * scale);
      ctx.fillStyle = "green";
      world.forEach((row, y) =>
        row.forEach(
          (alive, x) =>
            alive && ctx.fillRect(x * scale, y * scale, scale - 1, scale - 1)
        )
      );
    };

    

    let data = [];
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          data = JSON.parse(xhttp.response);
          let options = '';
          data.forEach((option, index) => {
            options += `<option value="${index}">${option.name}</option>`;
          });
          document.getElementById('selectPattern').innerHTML = options;
          handleChange();
        }
    };
    xhttp.open("GET", "./src/lexicon.json", true);
    xhttp.send();

    const handleChange = () => {
      let currentPattern = data[document.getElementById('selectPattern').value];
      document.getElementById('description').innerHTML = currentPattern.description;

      let pattern = currentPattern.pattern.split('\n');
      pattern = pattern.map(row => row.split(''));   

      if (Array.isArray(pattern) && Array.isArray(pattern[0])) {
        let world = putPatternInWorld(pattern);
        render(world);
      }
    }

    const putPatternInWorld = (pattern) => {
      let world = [...Array(worldHeight)].map(a => Array(worldWidth).fill(0));
      let width = pattern[0].length;
      let height = pattern.length;

      let startX = Math.floor((worldWidth - width) / 2);
      let startY = Math.floor((worldHeight - height) / 2);

      for (let i = 0; i < height; i++) {
        for (let j = 0; j < width; j++) {
          if (pattern[i][j] === 'O')
            world[startY + i][startX + j] = 1;
        }
      }

      return world;
    }

    const evolution = () => {

    }
  </script>
</html>
