<html>
  <head>
    <link rel="stylesheet" href="./src/index.css" />
  </head>
  <body>
    <canvas></canvas>
    <div>
      Select a pattern
      <select id="selectPattern">
      </select>
      <p id="description"></p>
      <button id="start">Start</button>
    </div>
  </body>
  <script type="module">
    import { parse, next } from './src/engine.js';
    import { WORLD_WIDTH, WORLD_HEIGHT } from './constants.js';
    const scale = 4;
    const worldWidth = WORLD_WIDTH;
    const worldHeight = WORLD_HEIGHT;

    const canvas = document.querySelector("canvas");
    canvas.width = worldWidth * scale;
    canvas.height = worldHeight * scale;
    const ctx = canvas.getContext("2d");

    const render = (world) => {
      ctx.fillStyle = "#202020";
      ctx.fillRect(0, 0, worldWidth * scale, worldHeight * scale);
      ctx.fillStyle = "green";
      world.forEach((row, y) =>
        row.forEach(
          (alive, x) =>
            alive && ctx.fillRect(x * scale, y * scale, scale - 1, scale - 1)
        )
      );
    };

    
    let interval;
    let data = [];
    let worldArray;
    const xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {
          data = JSON.parse(xhttp.response);
          let options = '';
          data.forEach((option, index) => {
            options += `<option value="${index}">${option.name}</option>`;
          });
          document.getElementById('selectPattern').innerHTML = options;
          handleChange();
        }
    };
    xhttp.open("GET", "./src/lexicon.json", true);
    xhttp.send();

    const handleChange = () => {
      clearInterval(interval);
      let currentPattern = data[document.getElementById('selectPattern').value];
      document.getElementById('description').innerHTML = currentPattern.description;

      let pattern = currentPattern.pattern.split('\n');
      pattern = pattern.map(row => row.split(''));   

      if (Array.isArray(pattern) && Array.isArray(pattern[0])) {
        worldArray = parse(pattern);
        render(worldArray);
      }
    }

    const evolution = () => {
      interval = setInterval(() => {
        worldArray = next(worldArray);
      }, 100);
    }

    document.getElementById("start").addEventListener("click", evolution);
    document.getElementById("selectPattern").addEventListener("change", handleChange);
  </script>
</html>
